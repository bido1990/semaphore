# Per ProxMox, you should use dist upgrade and not a regular 'apt upgrade'
- name: Upgrade ProxMox to Latest Version 
  apt:
    upgrade: dist
    update_cache: yes

- name: Check For Pending Reboot
  stat:
    path: /var/run/reboot-required
  register: reboot_required_check

- name: REBOOT REQUIRED
  pause:
    prompt: Update has detected that a reboot is necessary. Do you want to proceed with the update? (y/n)
  register: reboot_prompt
  when: reboot_required_check.stat.exists
  
- name: Reboot The Host After {{ pre_reboot_delay }} Seconds
  reboot:
    msg: 'Ansible initiated reboot is triggering in {{ pre_reboot_delay }} seconds..'
    pre_reboot_delay: '{{ pre_reboot_delay }}'
  when: 
   - reboot_required_check.stat.exists
   - reboot_prompt == 'y'
